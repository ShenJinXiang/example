package com.shenjinxiang.exam.netty;

import io.netty.bootstrap.Bootstrap;
import io.netty.channel.Channel;
import io.netty.channel.ChannelFuture;
import io.netty.channel.ChannelInitializer;
import io.netty.channel.EventLoopGroup;
import io.netty.channel.nio.NioEventLoopGroup;
import io.netty.channel.socket.nio.NioSocketChannel;
import io.netty.handler.codec.FixedLengthFrameDecoder;
import io.netty.handler.codec.LineBasedFrameDecoder;
import io.netty.handler.codec.string.StringDecoder;
import io.netty.handler.codec.string.StringEncoder;
import io.netty.util.CharsetUtil;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

/**
 * @Author: ShenJinXiang
 * @Date: 2020/8/1 22:14
 */
public class NettyTcpClient implements Runnable {

    private static final Logger logger = LoggerFactory.getLogger(NettyTcpClient.class);

    private EventLoopGroup group;
    private Bootstrap client;
    private String serverIp;
    private int serverPort;

    public NettyTcpClient(String serverIp, int serverPort, NettyTcpClientHandler handler) {
        this.serverIp = serverIp;
        this.serverPort = serverPort;
        group = new NioEventLoopGroup();
        client = new Bootstrap();
        client.group(group);
        client.channel(NioSocketChannel.class);
        client.handler(new ChannelInitializer() {
            @Override
            protected void initChannel(Channel channel) throws Exception {
//                channel.pipeline().addLast(new LineBasedFrameDecoder(1024 * 50));
                channel.pipeline().addLast(new FixedLengthFrameDecoder(4104));
//                channel.pipeline().addLast(new StringDecoder(CharsetUtil.UTF_8));
                channel.pipeline().addLast(handler);
                channel.pipeline().addLast(new StringEncoder(CharsetUtil.UTF_8));
            }
        });
    }

    @Override
    public void run() {
        try {
            ChannelFuture channelFuture = client.connect(this.serverIp, this.serverPort).sync();
            logger.info("TCP客户端启动，目标服务器: [" + this.serverIp + ":" + this.serverPort + "]");
            channelFuture.channel().closeFuture().sync();
        } catch (InterruptedException e) {
            logger.info("启动TCP客户端，目标服务器: [" + this.serverIp + ":" + this.serverPort + "] 出错", e);
        } finally {
            group.shutdownGracefully();
        }
    }

    public static void main(String[] args) {
        String str = "303030303030323634306238656466393431303261666631343130326161393334313066666530623431313163643764343131663933356234313237333337613431333065313363343132353462316534313262386433623431333966373663343132643333353834313165343666643431313937346463343132336136363434313139383037653431303963356261343066353739373734306535613364333430633633616262343038633033646133663637373162643366306463323266336538623838323533663036613464313364666135326563336635313163303762653030313335303366333338343039336539383832396433643863666331316263373735373938336462316530646262643432643231333365386134633665626632623462393062653839303237616265303132656262336564663861373033653036323134373365366163656333336438323565613762653333326534316264313033623962336630336238363562653164663237646265386630343430336632353936656233656632323930333364366638613066336532613638626133653863613639353366303937666336626438336535623962643834313935373365613665656133336564353631363033646135383563346264363133333461626561373564666333653136636133333364343638366236626364303964383433653636356662646264613738386237336339313834373533653262643662326265333131636634626430303232366262653737303332336265326437333137626537396532343933633831366363336264313333323132336431623264393562633731376365323365656562376436626463626437666433656533346430366265326466393263336630316163303233646437656462643365376539633336336536643738303062653630383331363364346436306437626466623033323362646462633465353365646663383332626563623237666133643637656562613365663930363835336530626566633762653832313663343365353464373335336536346664636262633431646665666265303139656562336630383061303562643836366430626264316331356236336562323432326633656531633363363365316364303532626435663634613162656531373132623365346530306132336535336131613262656161333864623365623732656431336562383734616133653061376336333365333137333730336562313861663133656632343466363365396532353566626438663836303533663362353539306265346165343135336537613938646462656431363363366263633834343432626462643332613033656339323332663364316662343865336534356363643833636338346262653365663636643938336631373263663633643336656431633365636635363439336538663336363633653238653132663366316230333934336562623039303833646134326634376265363535373932626564346332376433646632383030636265666235613564336433393235356433653365633331383365333534623238336465323164373162643665346266663365323630623764336534616232383033643366313837366264393366363436626561643631636362656430333436633366326464333836336534623832383333663237353564643362353639366564626533393234383933653265333539393366313836313134336536643765303062656562323566303366303838393938336534616138326533643930623963376265613430613639336539656133303333653036613631396264303433396138626562613438643662646139643439363364383861306266336539303638323233656162313335386265333332643262336563653363306362653064376130303365626636646138336561306639333433653531333737363365626230353462336537303231363562633963333663643364633162323964626235303766396433643464303561666265326665366561626465653730646562653832376330316264656364386265626534643662613133653735303634386264643730613362336430666333313833633861383435613364393962303638336464386466663033646130623839393364396162656362336439626435613833663166396533666265653837353736336535353832343433653636356263663365653866643230336630323239383762643131386164373365623535346337336437653561306262656535363838663365323534373135336536366262663733653964616533383366313530386463336631616563316533656631353836623364366638353839336631303637353333646263336663343364393733623866626466393836386533643761633939656265363761363662336439616464336633653863313736333365393961636138336435363934353362656263663964643365643761386634336432636563346233643539646430306265326330626166336532346532373133656538653264616265376634343238626630383231626662653532383266663365323365656133626439333733643533656538353234376265616335333535336538363464633833653739663237333365353237623933626363333434623633656330353839643365363663383064336434313537323033653435386535346265623564316265626536376636313933656564346438343364383534623536626463626331313733653431356563366264636639663738336464663436363933653238613064363365333337343064336563336333653733653261616362303365313932333164336532636365363162653934346331333364303364323464336566303664353733656332653661353366316132343631626538393338333133636263303731636264376165343731626331666361303362643161386539383364623564386164626364353032663133656430386335333366303666643731626461306364383733653162373261623365613431646338336630626534353633643063376163393365613935353130336535656436303162656161626465346264396630346635626530343863653033653866386230656265633431656662626535623038626462653839333266396264383666643564626538643930396462653363333961316264666361643735626433656265633233663335306639653365613764613263336339666230326533653638323962353365623833336163626436383238623333653763356166393363613630636161336565323732356333656162356630393365333464343662336630313933323633653536303336643365356633316537336630373862333833653231623438333365313031333331626435353362313633653331616634346265636166356164336438623239323933653038333833663364656638633233336562313838346462646231646335396265366262313531336532356162316433653134386361663365613834373562626431613230343533653934636666663365613065366132336362346361316333656261333566626265663363363738336439353737356462656563313331666264383965323132336461356266303833656536623531663364623063663531336538383636313733653565333733333365316331623137336530636436386362626633613466316264313832343865336363383135306433653436396331623365303439663261626538663031613562653863656136666264643063643763626331356263326433643538666361326264626439663038626538393630333862653662643435633365623562306430336539636430363633633238626636633365616364343936336539333030643062626261386433326264663737663133336436383035383062656138383564333365316636373863336530393264336633653363303137396265393535343931336633373735373433656436323430306265323331366332626433663830366233643761623363656263633265326631336536623836616562653839383235313365326630323133336438336431353133656238626135306265623732316136336538323138313362653438346662333363616532356132626233643135383733633730386665663366303230303035336536343262616662653231376332303365653035646534626466346633336533646464623238643365396661613931336564396135646333653862666339303365336132306365336465636233353033653232646534326263613265336461626531623464393662663030353465343364356665656331336464356631663033656262396263663365333164633035626533343162383333643130303266356265383839333266336539643865616233656132366332663364613032333433336561663032366533653336366532613364633833643961626533613032343433646136653232333365346535666238626562383334323762643532613838366265306638303237336535363437303162646663393137326265366164393964336563316332653433643035613861616264613038396566336533653534343362663136623935626265313134343836626438386631643233633534316230363365303030316530626434323666636433663061346232626266303335353130336538396531333133646638646332373365356461616331626538663863613433646239306430386265383565663339336530323239383733656562353330613366323031363766336633346130663633656130633330303364336630376435336631613737346133646465336238366265616162323930626335323463633662656364636330396265366537643965336532326138386333643137363463363365633864303936336536643063353933653561333237383365623561393535626562313565613833646230363339656264626230643233336464343965643362643062393633663365643463363432336535383030303962643337616665366264653233393031626330633738363833643963316666663364616134306230336531623430613762626638623638396265343936373461336539663636376133653533616365633365393033666638626562633166333333653537333832623366323164303662336565653235376533626361663665323365363135366161336565303964316562656334346439343365386465623962336635343237623233663030323064363364343532313732626230343464623662653836626630343365623336653230336531373138356233653365323836306266303637323531336436613737393462663839346566663364636632343033626632623832396262646530666661383365633734393738336330623862613533653338643666326266313735363634626462373035323133656335626666373365316132666131336562616539343662656238383431323366333337643234336536666630373733663935393863663430373362313634343039323136623934306265366537313430633835313564";
        System.out.println(str.length());
    }
}
